{% extends 'base.html.j2' %}

{% block body %}
<h1>Game Lobby: <span id="lobby-name">{{ match.name }}</span></h1>

<div id="game-info" class="game-info">
    <p><strong>Match ID:</strong> {{ match.id }}</p>
    <p><strong>Host (Player 1):</strong> <span id="p1name">{{ match.p1name }}</span></p>
    <p><strong>Player 2:</strong> <span id="p2name">{{ match.p2name if match.p2name else 'Waiting for player...'
            }}</span></p>
    <p><strong>Your Role:</strong> {{ 'Host (Player 1)' if is_host else 'Player 2' }}</p>
    <p><strong>Status:</strong> <span id="status">{{ 'Ready to Start' if match.p2name else 'Waiting for opponent...'
            }}</span></p>
</div>

<br>
<a href="../matches">Back to Matches</a>

<script>
    const matchId = {{ match.id }};

    function updateGameInfo() {
        fetch(`../api/match/${matchId}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) return;

                document.getElementById('p1name').textContent = data.p1name;
                document.getElementById('p2name').textContent = data.p2name ? data.p2name : 'Waiting for player...';

                const statusSpan = document.getElementById('status');
                if (data.p2name) {
                    statusSpan.textContent = 'Ready to Start';
                } else {
                    statusSpan.textContent = 'Waiting for opponent...';
                }
            })
            .catch(error => console.error('Error fetching match data:', error));
    }

    // Poll every 2 seconds
    setInterval(updateGameInfo, 2000);
</script>

<div id="chat-container">
    <div class="chat-header">Chat</div>
    <div id="chat-messages"></div>
    <div class="chat-input-area">
        <input type="text" id="chat-input" placeholder="Type a message...">
        <button onclick="sendMessage()">Send</button>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"
    integrity="sha512-q/dWJ3kcmjBLU4Qc47E4A9kTB4m3wuTY7vkFJDTZKjTs8jhyGQnaUrxa0Ytd0ssMZhbNua9hE+E7Qv1j+DyZwA=="
    crossorigin="anonymous"></script>
<script type="text/javascript" charset="utf-8">
    var socket = io();
    var room = "{{ match.id }}";
    var username = "{{ session['username'] }}";

    socket.on('connect', function () {
        socket.emit('join', { username: username, room: room });
    });

    socket.on('status', function (data) {
        var msgDiv = document.createElement('div');
        msgDiv.style.fontStyle = 'italic';
        msgDiv.style.color = '#888';
        msgDiv.textContent = data.msg;
        document.getElementById('chat-messages').appendChild(msgDiv);
    });

    socket.on('message', function (data) {
        var msgDiv = document.createElement('div');
        var userSpan = document.createElement('span');
        userSpan.style.fontWeight = 'bold';
        userSpan.textContent = data.user + ': ';
        var textSpan = document.createElement('span');
        textSpan.textContent = data.msg;
        msgDiv.appendChild(userSpan);
        msgDiv.appendChild(textSpan);
        document.getElementById('chat-messages').appendChild(msgDiv);
        var chatMessages = document.getElementById('chat-messages');
        chatMessages.scrollTop = chatMessages.scrollHeight;
    });

    function sendMessage() {
        var input = document.getElementById('chat-input');
        var msg = input.value;
        if (msg) {
            socket.emit('message', { username: username, room: room, msg: msg });
            input.value = '';
        }
    }

    document.getElementById('chat-input').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });
</script>
{% endblock %}